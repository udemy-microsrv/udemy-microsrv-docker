version: "3"
services:
  nats-main:
    image: nats:2.11
    container_name: udemy-microsrv__nats-main
    hostname: udemy-microsrv__nats-main
    ports:
      - "4422:4422"
      - "8222:8222"

  udemy-microsrv-gateway:
    build: ./udemy-microsrv-gateway
    container_name: udemy-microsrv__gateway
    hostname: udemy-microsrv__gateway
    ports:
      - "${GATEWAY_PORT}:3000"
    volumes:
      - ./udemy-microsrv-gateway/src:/usr/src/app/src
    environment:
      - PORT=3000
      - NATS_SERVERS=nats://udemy-microsrv__nats-main:4222

  udemy-microsrv-auth:
    build: ./udemy-microsrv-auth
    container_name: udemy-microsrv__auth
    hostname: udemy-microsrv__auth
    volumes:
      - ./udemy-microsrv-auth/src:/usr/src/app/src
    environment:
      - DATABASE_URL=${AUTH_DATABASE_URL}
      - NATS_SERVERS=nats://udemy-microsrv__nats-main:4222
      - JWT_SECRET=${AUTH_JWT_SECRET}
    command: ["npm", "run", "start:dev:docker"]

  udemy-microsrv-product:
    build: ./udemy-microsrv-product
    container_name: udemy-microsrv__product
    hostname: udemy-microsrv__product
    volumes:
      - ./udemy-microsrv-product/src:/usr/src/app/src
    environment:
      - DATABASE_URL=file:./dev.db
      - NATS_SERVERS=nats://udemy-microsrv__nats-main:4222
    command: ["npm", "run", "start:dev:docker"]

  udemy-microsrv-order:
    build: ./udemy-microsrv-order
    container_name: udemy-microsrv__order
    hostname: udemy-microsrv__order
    volumes:
      - ./udemy-microsrv-order/src:/usr/src/app/src
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@udemy-microsrv__postgresql:5432/${POSTGRES_DB}?schema=public
      - NATS_SERVERS=nats://udemy-microsrv__nats-main:4222
    command: ["npm", "run", "start:dev:docker"]
    depends_on:
      - postgresql

  udemy-microsrv-payment:
    build: ./udemy-microsrv-payment
    container_name: udemy-microsrv__payment
    hostname: udemy-microsrv__payment
    ports:
      - "${PAYMENT_PORT}:3000"
    volumes:
      - ./udemy-microsrv-payment/src:/usr/src/app/src
    environment:
      - PORT=3000
      - STRIPE_SECRET_KEY=${PAYMENT_STRIPE_SECRET_KEY}
      - STRIPE_SUCCESS_URL=${PAYMENT_STRIPE_SUCCESS_URL}
      - STRIPE_CANCEL_URL=${PAYMENT_STRIPE_CANCEL_URL}
      - STRIPE_WEBHOOK_SECRET=${PAYMENT_STRIPE_WEBHOOK_SECRET}
      - NATS_SERVERS=nats://udemy-microsrv__nats-main:4222

  postgresql:
    image: postgres:16.8
    container_name: udemy-microsrv__postgresql
    hostname: udemy-microsrv__postgresql
    ports:
      - "5432:5432"
    volumes:
      - udemy-microsrv__postgresql__data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}

volumes:
  udemy-microsrv__postgresql__data:
